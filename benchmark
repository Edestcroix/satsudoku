#! /usr/bin/env python3
import argparse
import os
import shutil
from typing import List, Tuple
import json

import src.convertSUD as Sud
from src.benchmarking import SatSolver, TestData, Tester, TestResult
from src.convertCNF import Encoding
from src.tableMD import RawTable, Table
from src.tableMD import create as create_table

CONFIG_FILE = "config.json"

with open(CONFIG_FILE, "r") as f:
    CONFIG = json.load(f)
puzzles = CONFIG["puzzles"]
for key in puzzles:
    CONFIG["puzzles"][key] = (f"{CONFIG['puzzleDir']}/{puzzles[key]['file']}", puzzles[key]
                              ['num_puzzles'], puzzles[key]['puzzle_size'], puzzles[key]['puzzle_offset'])
def main():
    # set up argument parser
    # with argument flag -c
    # which shows the CPU time for each puzzle

    parser = argparse.ArgumentParser(
        description="Run tests on the sudoku solver")
    args = setup_args(parser)
    if args.clean:
        shutil.rmtree(CONFIG["resultsDir"])
        exit(0)

    all_tests, summary, keep, decode = \
        (True, True, True, True) if args.complete\
        else (args.all, args.summarize, args.keep, args.decode)

    if summary and not all_tests:
        print("Error: -S must be used with -a")
        exit(1)

    make_dirs()
    run_tests(args, (all_tests, summary, keep, decode))


def make_dirs() -> None:
    if os.path.isdir(CONFIG["cacheDir"]):
        shutil.rmtree(CONFIG["cacheDir"])
    os.mkdir(CONFIG["cacheDir"])
    if not os.path.isdir(CONFIG["resultsDir"]):
        os.mkdir(CONFIG["resultsDir"])

    
def setup_args(parser: argparse.ArgumentParser) -> argparse.Namespace:
    parser.add_argument("-s", "--silent", action="store_true",)
    # add argument flag -t to specify which test to run
    # default is to run all tests
    parser.add_argument("-t", "--test", type=str, default="",
                        help="test to run (standard, hard)")
    parser.add_argument("-e", "--enc", type=str, default="",
                        help="encoding to use (minimum, efficient, extended)")
    parser.add_argument("-a", "--all", action="store_true",
                        help="run all tests")
    parser.add_argument("-k", "--keep", action="store_true",
                        help="keep converted CNF files and solver output")
    parser.add_argument("-S", "--summarize", action="store_true",
                        help="summarize results from -a")
    parser.add_argument("-d", "--decode", action="store_true",
                        help="decode solved puzzles")
    parser.add_argument("-C", "--complete", action="store_true",
                        help="run all tests and summarize results")
    parser.add_argument("-c", "--clean", action="store_true",
                        help="clean benchmark directory")
    return parser.parse_args()


def run_tests(args: argparse.Namespace, params: tuple) -> None:
    all_tests, summary, keep, decode = params
    if all_tests:
        # fail if -t or -e specified with -a
        if args.test != "" or args.enc != "":
            print("Error: -a/-C cannot be used with flags other -s")
            return
        test_all(summary, args.silent)
    else:
        run_single_test(args.enc, args.test, args.silent)

    if decode:
        copy_solution_dir(args.silent)
    if keep:
        copy_working_dir(args.silent)
    else:
        shutil.rmtree(CONFIG["cacheDir"])


def run_single_test(enc: str, test: str, silent: bool) -> None:
    if enc in {"minimal", "efficient", "extended"}:
        encoding = Encoding(enc.upper())
    elif not enc:
        encoding = Encoding.MINIMAL
    else:
        print("Error: invalid encoding")
        exit(1)


    puzzles = CONFIG["puzzles"]
    
    out = f"{CONFIG['resultsDir']}test_results.md"

    test = test.capitalize() if test != "" else list(puzzles.keys())[0]
    if test not in puzzles:
        print("Error: invalid test")
        exit(1)
    testdata = TestData(silent, test, encoding, *puzzles[test])
    solver = SatSolver(puzzles[test][1], test)
    tester = Tester(testdata, solver)
    tester.test(out)


def print_if_not(b: bool, str: str) -> None:
    None if b else print(str)


def copy_solution_dir(silent: bool) -> None:
    out_dir: str = CONFIG["resultsDir"]
    # add trailing slash if not present
    if out_dir[-1] != "/":
        out_dir += "/"
    decode_solutions()
    if os.path.isdir(f"{out_dir}solutions"):
        shutil.rmtree(f"{out_dir}solutions")
    shutil.move(f"{CONFIG['cacheDir']}solutions", out_dir)

    print_if_not(
        silent, f"Decoded solutions written to {out_dir}solutions")


def copy_working_dir(silent: bool) -> None:
    # move contents cache dir to results dir
    out_dir = CONFIG["resultsDir"]
    # add trailing slash if not present
    if out_dir[-1] != "/":
        out_dir += "/"

    if not os.path.isdir(out_dir):
        os.mkdir(out_dir)
    if os.path.isdir(f"{out_dir}{CONFIG['cacheDir']}"):
        shutil.rmtree(f"{out_dir}{CONFIG['cacheDir']}")
    try:
        shutil.move(CONFIG["cacheDir"], out_dir)
    except Exception as e:
        print_if_not(silent, "Failed to move CNF files and solver output to " +
                     out_dir+"encodings")
        print_if_not(silent, str(e))
    else:
        if os.path.isdir(f"{out_dir}encodings"):
            shutil.rmtree(f"{out_dir}encodings")
        os.rename(f"{out_dir}{CONFIG['cacheDir']}", f"{out_dir}encodings")
        print_if_not(silent, "Converted CNF files and solver output saved to " +
                     out_dir+"encodings")


def summarize(results: RawTable, puzzles) -> None:
    sum_file = f"{CONFIG['resultsDir']}summary.md"
    # header is generated from the keys of the puzzles dict,
    # this allows for easy addition of tests with new puzzles
    # and the summary will automatically update

    def header_func(x):
        return f"Averages â€• {tuple(puzzles.keys())[x-1]} Puzzles"
    cols = ["Encoding", "Decisions", "Decision Rate (dcsns/sec)",
            "Propositions", "Proposition Rate (props/sec)", "CPU Time (seconds)"]
    with open(sum_file, "w") as f:
        f.write(create_table("Results Summary", results,
                cols, sep_func=header_func, new_line=False))


def test_all(summary: bool = False, silent: bool = False) -> None:
    out = CONFIG["resultsDir"]
    puzzles = CONFIG["puzzles"]
    msg: str = "Testing {0} puzzles with {1} encoding..."
    print_if_not(silent, f"Running all tests, outputting to {out}")
    print_if_not(silent, "This may take a while...")

    first_test = list(puzzles.keys())[0]
    testdata: TestData = TestData(True, first_test.capitalize(), Encoding.MINIMAL,
                                  *puzzles[first_test])

    # initialize tester with standard puzzles
    tester: Tester = Tester(testdata, SatSolver(
        puzzles[first_test][1], first_test.capitalize()))

    results: List[TestResult] = []
    i: int = 1

    # iterates through all test puzzle files and all encodings
    for test in puzzles.keys():
        # update tester parameters when switching tests
        tester.update_params(
            TestData(True, test, Encoding.MINIMAL, *puzzles[test]))
        for enc in Encoding:
            name: str = enc.name.lower()
            t: str = test.lower()
            out_file: str = f"{out}{str(i).zfill(2)}-{t}-{name}.md"

            print_if_not(silent, format(msg.format(t, name)))
            tester.update_encoding(enc)
            results.append(tester.test(out_file))
            i += 1

    print_if_not(silent, "Done!")
    if summary:
        summarize(results, puzzles)
        print_if_not(silent, f"Summary saved to {out}summary.md")


def decode_solutions() -> None:
    # decode solutions from minisat output
    standard_dir = f"{CONFIG['cacheDir']}sat/standard/"
    hard_dir = f"{CONFIG['cacheDir']}sat/hard/"
    if os.path.exists(standard_dir):
        decode_dir('solutions/standard/', standard_dir,
                   'solutions/standard/sudoku_')
    if os.path.exists(f"{CONFIG['cacheDir']}sat/hard"):
        decode_dir('/solutions/hard/', hard_dir, 'solutions/hard/sudoku_')


def decode_dir(out_dir: str, in_dir: str, out_name_head: str) -> None:
    os.system(f"mkdir -p {CONFIG['cacheDir']}{out_dir}")
    # count how many files are in standard_dir
    count = len(list(os.listdir(in_dir)))
    for i in range(count):
        filename = f"{in_dir}sudoku_{str(i + 1).zfill(2)}.out"
        # read file and pass to Sud.convert
        with open(filename, "r") as in_file:
            lines = in_file.readlines()

            table = sudoku_to_table(Sud.convert(
                lines[1]), f"Solution {str(i+1).zfill(2)}")
            outfile = f"{CONFIG['cacheDir']}{out_name_head}{str(i + 1).zfill(2)}.md"

            with open(outfile, "w") as out:
                out.write(table)


def sudoku_to_table(sudoku: str, title: str) -> Table:
    # convert a sudoku puzzle to a table
    cell_grid = sudoku.replace(" ", "").split("\n")
    cell_grid = [line for line in cell_grid if line != ""]
    cell_grid = [list(line) for line in cell_grid]
    dummy = [""] * 9
    cell_grid = [dummy] + cell_grid

    return create_table(title, cell_grid, new_line=False, sep=False)


if __name__ == "__main__":
    main()
